version: "3.2"
services:
    postgres:
        hostname: postgres
        ports:
            - "5432:5432"
        image: postgres:14
        environment:
            - POSTGRES_DB=upchieve
            - POSTGRES_USER=admin
            - POSTGRES_PASSWORD=Password123
        volumes:
            - ./database/db_init/schema.sql:/docker-entrypoint-initdb.d/init_db.sql
            - ./database/db_init/auth.sql:/docker-entrypoint-initdb.d/init_roles.sql
          # - ./database/db_init/pgulid.sql:/docker-entrypoint-initdb.d/init_ulid.sql
    mongodb:
        hostname: mongodb
        ports:
            - "27017-27019:27017-27019"
        image: mongo:4.4.5
        environment:
            - MONGO_INITDB_DATABASE=upchieve
        volumes:
            - ./mongo-volume:/data/db
    redis:
        hostname: redis
        ports:
            - "6379:6379"
        image: redis:6.2.1
        volumes:
            - ./redis-volume:/data
    pgadmin:
        image: dpage/pgadmin4
        depends_on:
            - postgres
        entrypoint: >
            /bin/sh -c "
            mkdir -m 700 /var/lib/pgadmin/storage/admin_upchieve.org;
            chown -R pgadmin:pgadmin /var/lib/pgadmin/storage/admin_upchieve.org;
            cp -prv /pgpassfile /var/lib/pgadmin/storage/admin_upchieve.org/;
            chmod 600 /var/lib/pgadmin/storage/admin_upchieve.org/pgpassfile;
            /entrypoint.sh
            "
        ports:
            - "80:80"
        environment:
            - PGADMIN_DEFAULT_EMAIL=admin@upchieve.org
            - PGADMIN_DEFAULT_PASSWORD=Password123
        volumes:
            - ./pgadmin/pgpassfile:/pgpassfile
            - ./pgadmin/servers.json:/pgadmin4/servers.json
        restart: unless-stopped
